name: Module 01 - Backend Docker Grading

on:
  push:
    paths:
      - 'assignments/module-01-dockerize-backend/**'
      - 'backend/**'
  pull_request:
    paths:
      - 'assignments/module-01-dockerize-backend/**'

jobs:
  grade-module-01:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Dockerfile exists
        run: |
          if [ ! -f "assignments/module-01-dockerize-backend/starter/Dockerfile" ]; then
            echo "Dockerfile not found in starter directory"
            exit 1
          fi
          echo "Dockerfile found"

      - name: Build Docker image
        run: |
          docker build -f assignments/module-01-dockerize-backend/starter/Dockerfile -t backend-test backend
          echo "Docker build succeeded"

      - name: Check image size
        run: |
          IMAGE_SIZE=$(docker image inspect backend-test --format='{{.Size}}')
          IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
          echo "Image size: ${IMAGE_SIZE_MB}MB"
          if [ $IMAGE_SIZE_MB -gt 300 ]; then
            echo "Warning: Image size is ${IMAGE_SIZE_MB}MB. Consider optimizing (target: < 200MB)"
          fi

      - name: Start PostgreSQL for testing
        run: |
          docker run -d --name postgres-test \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=classroom_db \
            -p 5432:5432 \
            postgres:16-alpine
          sleep 10

      - name: Run container
        run: |
          docker run -d --name backend-test -p 3000:3000 \
            -e NODE_ENV=development \
            -e PORT=3000 \
            -e DB_HOST=172.17.0.1 \
            -e DB_PORT=5432 \
            -e DB_NAME=classroom_db \
            -e DB_USER=postgres \
            -e DB_PASSWORD=postgres \
            backend-test

      - name: Wait for application
        run: |
          for i in $(seq 1 30); do
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "Application is ready"
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          echo "Application failed to start"
          docker logs backend-test
          exit 1

      - name: Test health endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Health endpoint returned 200 OK"
          else
            echo "Health endpoint returned $HTTP_CODE (expected 200)"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          docker stop backend-test postgres-test || true
          docker rm backend-test postgres-test || true

      - name: Summary
        if: success()
        run: |
          echo "Module 01 Grading: PASSED - 10/10 points"
